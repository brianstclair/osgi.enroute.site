<!DOCTYPE html>
<html lang="en" ng-app="jpm">

	<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="/css/style.css" rel="stylesheet" />
<title>org.osgi.service.cm</title>


</head>


<body>

	
	
	
	
	
	
		
		
		
			<style>
				 body {
					counter-reset: h1 1;
				}
			</style>
			
			
		
		
		
	
	
		
			
			
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	
	
		
		
		
		
		
	

	<ul class="container12 menu-bar">
	<li span=10><a class=menu-link href="/"><img class=menu-logo
			src='/img/EnRouteIcon_CMYK.png'></a> <a
		href="/book/100-introduction.html">Guide </a><a
		href="/book/400-services.html">Services </a><a
		href="/book/700-links.html">Links </a><a
		href="/forum.html">Forum</a>
	<li class=menu-link span=1>
	<li class=menu-link span=1><a style="display:block;float:right;margin-right:0px;" href=http://www.osgi.org">OSGi</a></div>
	
</ul>


	<ul class=container12>
		<li span=3>
			<div>
			<ul class="side-nav">
	
		
			<li><a href="/book/100-introduction.html">Guide</a>
	  	
  	
		
			<li><a href="/book/200-quick-start.html">Quick Start Tutorial</a>
	  	
  	
		
			<li><a href="/book/210-overview.html">Overview</a>
	  	
  	
		
			<li><a href="/book/215-sos.html">Building Service Oriented Systems</a>
	  	
  	
		
			<li><a href="/book/220-tutorial-base.html">Base Tutorial</a>
	  	
  	
		
			<li><a href="/book/300-principles.html">Principles</a>
	  	
  	
		
			<li><a href="/book/400-services.html">Service Catalog</a>
	  	
  	
		
			<li><a href="/book/700-links.html">Where to Find Stuff</a>
	  	
  	
</ul>

			</div>
			
		<li span=9>
			<a class=nav-prev href="" >Prev</a>
			<a class=nav-next href="/services/org.osgi.service.component.html" >Next</a>
			<br/>
			<hr/>
			 
			<div class='notes-margin book'>
				<h1> org.osgi.service.cm</h1>
				<p><img src="/img/services/org.osgi.service.cm.overview.png" alt="Configuration Admin Collaboration Diagram" /></p>

<h2 id="when-to-use">When to Use?</h2>

<p>Configuration Admin is, obviously, about configuration. It is probably one of the most fundamental specifications in the compendium. Though you should use Configuration Admin any time you need configuration, you should actually rarely use it directly. </p>

<p>Declarative Services, the rock solid foundation of OSGi enRoute, has a very close integration with Configuration Admin. In almost all cases you will receive your configuration in the <code>activate</code> method. So if you just want to get configuration data, then consult the <a href="/services/org.osgi.service.component.html">Declarative Services</a> service catalog entry. </p>

<p>Hmm, you seem to be still reading, so be prepared to dive a bit deeper. There are a few advanced cases where directly using Configuration Admin comes in handy. </p>

<ul>
  <li>You’re writing middleware and need to work closely with Configuration Admin.</li>
  <li>You want to receive multiple configurations</li>
  <li>You want to set configuration for other components</li>
</ul>

<h2 id="example-usage">Example Usage</h2>

<p>The following snippet shows a small example how you can use Configuration Admin to create a singleton configuration:</p>

<pre><code>Configuration configuration = cm.getConfiguration("singleton", "?");
Hashtable&lt;String, Object&gt; map = new Hashtable&lt;String,Object&gt;();
map.put("msg", "Hello Singleton");
configuration.update(map);
</code></pre>

<p>The following creates a factory configuration:</p>

<pre><code>Configuration a = cm.createFactoryConfiguration("factory", "?");
Hashtable&lt;String, Object&gt; map = new Hashtable&lt;String,Object&gt;();
map.put("msg", "Hello Factory");
a.update(map);
</code></pre>

<p>You can list all configurations with the following snippet:</p>

<pre><code>public Collection&lt;Map&lt;String, Object&gt;&gt; findConfigurations(String filter)
		throws IOException, InvalidSyntaxException {
	return getConfigurations0(filter).map(
			(c) -&gt; ca.toMap(c.getProperties()))
			.collect(Collectors.toList());
}

private Stream&lt;Configuration&gt; getConfigurations0(String filter)
		throws IOException, InvalidSyntaxException {

	Configuration[] configurations = cm.listConfigurations(filter);
	if (configurations == null)
		configurations = EMPTY;

	return Arrays.stream(configurations);
}
</code></pre>

<h2 id="background">Background</h2>

<p>Most people that first see the OSGi Configuration Admin find it a rather odd API. Most developers want to get their configuration somewhere and process it. Not in this API. The basic model is push (or in more trendy terms: async!). To get configuration, you register a Managed Service or a Managed Service Factory and then … do nothing. One day, when the Configuration Admin feels like, it will call you with the configuration properties. Only then you should start doing whatever you were supposed to be doing with those properties Whenever there are new configuration properties, Configuration Admin will call you again. So Configuration Admin collapses the case of starting and getting your configuration and updating your configuration. It only knows how to update you with new properties.</p>

<p>Lots of developers are upset about this model because they worry that Configuration Admin is not around and they have to “wait” forever (they’re not waiting, they’re just being ignored). Good designers are humble and just wait until it is their turn; they understand that certain aspects of the overall system should not be managed in each component. Bad designers have no clue what this means. In a proper OSGi enRoute design the component reacts to its configuration updates.</p>

<p>OSGi provides a standardized model to provide bundles with <em>confgurations</em> in the Configuration Admin specification. Every configuration is identified by a persistent identity (PID). A PID is a unique token that follows the symbolic name syntax. A configuration consists of a set of <em>properties</em>, where a property consists of a string key and a corresponding value. The type of the value is limited to the primitive types and their wrappers as well as arrays or Java Vector or List classes. </p>

<h3 id="singletons-and-factories">Singletons and Factories</h3>

<p>Configurations can be grouped with a factory PID, these are called <em>factory</em> configurations, this leaves us with naming the configurations that are not factories (we’de like to remain positive) so let’s call them singletons.</p>

<p>Now here we need a tad of history. Originally the model was that if you wanted a singleton configuration you registered a Managed Service (service) and if you want to be notified when factory instances were created or deleted you registered a Managed Service Factory service. Since a singleton can have at most one value for a PID, the <code>ManagedService</code> interface only supports a simple <code>updated()</code> method that receives the properties. A factory represents 0 or more instances, the <code>ManagedServiceFactory</code> interface therefore has an <code>updated()</code> method that takes an instance PID and properties as well as a <code>deleted()</code> method that that takes the factory PID.</p>

<p>So why do we have 2 managed service types? Singletons (<code>ManagedServce</code>) and factories (<code>ManagedServiceFactory</code>). </p>

<p>A singleton gives you one set of properties, no less and no more. For example, you have a bundle that provides a simple HTTP server. If the server can only run on one port you would use the singleton configuration to parameterize it. </p>

<p>The magic is in the factories, they allow you to define multiple sets of properties. In <a href="/services/org.osgi.service.component.html">Declarative Services</a> factories allow you to instantiate a component multiple times. For example, if you have a more advanced HTTP server that can run on different ports with different configurations then you would use the factory for each configuration.</p>

<h3 id="pids">PIDs</h3>

<p>PID stands for <em>Persistent IDentity</em>. It is an identifier with a dotted name (like a Java fully qualified name) that links a bundle to a set of properties. A.k.a. a primary key. When a bundle wants to get its configuration it registers a Managed Service with the PID as the service property. PIDs are so fundamental that this the only non-framework entity with its own OSGi Framework constant: <code>Constants.SERVICE_PID</code> (<code>service.pid</code>).</p>

<p>Configuration Admin detects the PID and will look in its database of configuration records. If it has a set of properties, it will call the service with those properties, otherwise it will call it with a <code>null</code>. That is, the Managed Service is <em>always</em> called.</p>

<p>Managed Service Factory work similar but their PID is treated as a <em>factory pid</em>. The Configuration Admin will look in its database for records and finds any records that are marked with that factory PID. Each entry is then turned into properties and send to the Managed Service Factory <code>update</code> method. This <code>update</code> method takes two parameters: a PID and  a set of properties. The PID is not the factory PID, it is the <em>instance PID</em>, the primary key of the record.</p>

<p>If a configuration is deleted through Configuration Admin then the Managed Service will be called on its <code>update</code> method with a <code>null</code>. A Managed Service Factory has a special delete method that takes the instance PID. </p>

<h3 id="locations">Locations</h3>

<p>Locations were a mistake in the Configuration Admin API. Ok, I’ve said it. They were a failed attempt to provide security at an unsuitable place. Mea culpa … The intention was that we could restrict configurations to specific bundles, this restriction was actually automatic when the location was set to <code>null</code> and a bundle used it. Countless hours have been lost figuring out why Configuration Admin did not call <code>update</code> only to discover that the location was wrong. Alas, the sins we commit when we try to specify.</p>

<p>So what should you do with the location? Well, just set it always to “?”. This is a recent addition to the specification that basically removes the awkward location check. </p>

<h2 id="example-application">Example Application</h2>

<p>You can find an example application at <a href="https://github.com/osgi/osgi.enroute.examples/tree/master/osgi.enroute.examples.cm.application">OSGi enRoute Example</a>. This application is a simple web application that provides an implementation for all actors in the Configuration Admin service specification except for Configuration Admin itself. The application has a number of buttons to execute simple scenarios. Run it in debug mode, set breakpoints, and enjoy.</p>


			</div>
			<hr/>
			<a class=nav-prev href="" >Prev</a>
			<a class=nav-next href="/services/org.osgi.service.component.html" >Next</a> 
	</ul>

	
<nav class=next-prev>
	<a href=''></a> <a href=''></a>
</nav>
<footer class="container12" style="border-top: 1px solid black;padding:10px 0">
	<ul span=12 row>
		<li span=3>
			<ul>
				<li><a href="/contact.html">Contact</a>
			</ul>
		<li span=3>
			<ul>
				<li><a href="">Developers</a>
			</ul>
		<li span=4>
			<ul>
				<li><a href="">More</a>
			</ul>
		<li span=2>
			<a href="http://www.osgi.org"><img style="float:right;width:8em" src="/img/osgi-logo-256.png"></a>
	</ul>
</footer>

</body>
</html>
