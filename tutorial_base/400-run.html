<!DOCTYPE html>
<html lang="en" ng-app="jpm">

	<head>
<meta charset="utf-8" />
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="/css/style.css" rel="stylesheet" />
<title>Running Your Code</title>


</head>


<body>

	<ul class="container12 menu-bar">
	<li span=10><a class=menu-link href="/"><img class=menu-logo
			src='/img/EnRouteIcon_CMYK.png'></a> <a
		href="/book/100-introduction.html">Guide </a><a
		href="/book/400-services.html">Services </a><a
		href="/book/700-links.html">Links </a><a
		href="/forum.html">Forum</a>
	<li class=menu-link span=1>
	<li class=menu-link span=1><b>BETA</b>
	
</ul>


					

	<ul class=container12>
		<li span=3>
			<div>
			<ul class="side-nav">
	
		
			<li><a href="/book/100-introduction.html">Guide</a>
	  	
  	
		
			<li><a href="/book/200-quick-start.html">Quick Start Tutorial</a>
	  	
  	
		
			<li><a href="/book/210-overview.html">Overview</a>
	  	
  	
		
			<li><a href="/book/215-sos.html">Building Service Oriented Systems</a>
	  	
  	
		
			<li><a href="/book/220-tutorial-base.html">Base Tutorial</a>
	  	
  	
		
			<li><a href="/book/300-principles.html">Principles</a>
	  	
  	
		
			<li><a href="/book/400-services.html">Service Catalog</a>
	  	
  	
		
			<li><a href="/book/700-links.html">Where to Find Stuff</a>
	  	
  	
</ul>

			</div>
			
		<li span=9>
			<div>
				<a class=nav-prev href="340-junit.html" >Prev</a>
				<a class=nav-next href="450-debug.html" >Next</a> 
				<br/>
				<hr/>
				<h1> Running Your Code</h1>
				<div class=tutorial-content>
				<h2 id="what-you-will-learn-in-this-section">What You Will Learn in This Section</h2>

<p>In this section we will take the project we created in the previous section and make it run inside an actual framework. This requires to select the <em>initial requirements</em> of a runtime and the let bndtools resolve this into a set of <em>run bundles</em>. We then run the framework.</p>

<h2 id="what-to-run">What to Run?</h2>

<p>We could of course run our current project but that raises the existential question: what are we actually running? Looking at the provider code we’ve created we cannot but notice that it is a rather lazy bum (lazy is good!); the Eval Provider implementation of the Eval service waits until it gets called. So to make it do anything noticeable, we will need to add some behavior.</p>

<p>The way we usually usually do this in OSGi is by creating a command in the <a href="http://felix.apache.org/site/apache-felix-gogo.html">Apache Felix Gogo Shell</a>. This sounds much more complicated than it is since Gogo can call any method on any service if given permission. You grant this permission by adding some special <em>service properties</em>. Just change the @Component annotation on our <code>EvalImpl</code> class to:</p>

<pre><code>@Component(
	name = "com.acme.prime.eval", 
	property = {
		Debug.COMMAND_SCOPE + "=test", 
		Debug.COMMAND_FUNCTION + "=eval" 
	}
)
</code></pre>

<p>These properties register the <code>test:eval</code> command with Gogo. The scope (the <code>test</code> part) is always required to disambiguate commands. (In this case it is actually really required since Gogo already has an eval command, ok, bad planning).</p>

<h2 id="runtime-environment">Runtime Environment</h2>

<p>The Runtime Environment defines what OSGi Framework should be running, how that framework should be configured, what support bundles should be loaded, and some other parameters. The ‘Run’ tab of the <code>bnd.bnd</code> editor is designed to set this information, so double click on <code>bnd.bnd</code> and select the <code>Run</code> tab.</p>

<p><img src="/img/tutorial_base/run-run-0.png" alt="Run tab" /></p>

<p>The ‘Run’ tab consists of a number of sections that we will discuss in the following sections.</p>

<h3 id="core-runtime">Core Runtime</h3>

<p>The <code>Core Runtime</code> section allows us to select a framework and an execution environment. You should set those to the <code>org.eclipse.osgi</code> (Eclipse Equinox) framework and choose the <code>JavaSE-1.8</code> execution environment. An execution environment is basically a version of Java-SE.</p>

<h3 id="run-requirements">Run Requirements</h3>

<p>One of the most annoying aspects of software is always making sure you have your dependencies in place. Especially in an OSGi enRoute environment where we go out of our way to not depend on implementations (we compile only against service API) it could be a bit of work to find a matching set of bundles for our runtime. That is, if there was no ‘Resolve’ button.</p>

<p>Since there is a ‘Resolve’ button, we can get away with only specifying our <em>requirements</em> and leave the blue collar assembly work to bndtools. Let’s see how this works. </p>

<p>The <code>Run</code> tab contains a a <code>Run Requirements</code> section. This section contains a list with the <em>initial requirements</em>. You can drag any bundle on the left from the <code>Available Bundles</code> list into the requirements list. We only really want to run our own bundle, so the initial content is ok: <code>com.acme.prime.eval.provider</code>. This is a requirement to our current bundle, which is already set by default (clever!). </p>

<p>We did not create an implied requirement in our code on the Gogo shell since we only used properties. If Gogo is present, we provide a command, otherwise we do not bother. However, we want to run Gogo in our runtime so we can play with our code. So to make our runtime more fun we need to add the initial requirement <code>org.apache.felix.gogo.shell</code>, this will make sure we have the shell present. </p>

<p><img src="/img/tutorial_base/run-require-0.png" alt="Initial Requirements" /></p>

<p>Since this bundle uses Declarative Services (DS), it needs at least a DS implementation, and of course whatever that DS implementation needs, ad nauseum. When you hit the <code>Resolve</code> button, the bnd resolver will try to create a closure of a set of bundles so that all requirements are satisfied. So hit it! It will pop up a window that shows the set of bundles that it found. If not, at least it should show you the diagnostics of what is missing. So if things go well, and why shouldn’t they, you shoud see the following dialog:</p>

<p><img src="/img/tutorial_base/run-require-1.png" alt="Resolve result" /></p>

<p>If you accept the result, the list becomes the run bundles specification for this <code>bnd.bnd</code> file. You can inspect this list by clicking on the <code>Run Bundles</code> section, right down on the <code>bnd.bnd</code> <code>Run</code> tab.</p>

<p><img src="/img/tutorial_base/run-require-2.png" alt="Run bundles" /></p>

<p>What we have done so far is all in memory, you will need to save the <code>bnd.bnd</code> file to make this effective.</p>

<h2 id="launching">Launching</h2>

<p>At the right-top of the <code>Run</code> tab you see a <code>Run OSGi</code> and <code>Debug OSGi</code> button. Hit one of them and enjoy the warm welcome from your first amazing enRoute application. You can be proud of yourself! That is, if you can’t find it, it is at the bottom part of the window, the output of the Eclipse console.</p>

<p><img src="/img/tutorial_base/run-launch-0.png" alt="Running" /></p>

<p>Of course we’re highly interested in the answer to ultimate question of how much 21+21 is:</p>

<pre class="shell"><code>g! test:eval 21+21
42.0
</code></pre>

<p>Sometimes, you know, life is just good …</p>

<h2 id="updating">Updating</h2>

<p>Adding, subtracting, gets a bit boring after a while, didn’t the bible tell us to multiply? So why not be nice and add multiplication and division:</p>

<pre><code>Pattern EXPR = Pattern
		.compile("\\s*(?&lt;left&gt;\\d+)\\s*(?&lt;op&gt;\\+|-|\\*|/)\\s*(?&lt;right&gt;\\d+)\\s*");

....

	switch (m.group("op")) {
	case "+":
		return left + right;
	case "-":
		return left - right;
	case "*":
		return left * right;
	case "/":
		return left / right;
	}
</code></pre>

<p>Just add the new code and save the <code>EvalImpl</code> class, then go to the Gogo shell. Hmm, you did not really have to stop the framework, in the OSGi world we are dynamic. So if you out of bad habit killed the running process you should first restart the framework. Click on the <code>bnd.bnd</code> file, select the <code>Run</code> tab and click the <code>Debug OSGi</code> button. If you don’t understand what I am talking about you’re framework should still be humming along, having just been updated. So assuming we’re all in the Gogo shell now:</p>

<pre class="shell"><code>g! test:eval 6*7
42.0
</code></pre>

<p>What happened? When we changed the source code, the IDE compiled the class, which triggered bnd to build the bundle. A changed bundle is detected by the launcher and automatically deployed to the running framework. This obviously required our bundle to be updated. In practice, you rarely have to restart the framework, everything you change in the IDE, including changes in the bnd.bnd file are quickly deployed to the running framework.</p>

<h2 id="how-does-it-work">How Does it Work?</h2>

<p>When you launch an application a launcher is started in a remote process. This launcher gets a properties that describes what framework to use, what bundles to load etc. This properties file is created by bndtools. After the launcher has initialized everything, it starts the bundles and then starts watching the properties file. If this file changes, it reloads it and calculates a delta and then applies this delta to the running framework. This works for most of the information but not everything.</p>

<p>In the bndtools process we are listening to changes to any of the information that was used to created the properties file. If such a change is detected, the launch property file is recreated, thereby triggering the launcher.   </p>

<p>To develop in such a dynamic environment is actually good practice even if you run the system quite statically. The dynamism during development will point out a lot of potential issues and make your code much more robust. It is a bit like fighter pilots. They get trained at a 10% higher speed than reality, when they hit the dog fight they can feel quite zen because it is so much slower than what they’re used to! </p>


				</div>
				<hr/>
				<a class=nav-prev href="340-junit.html" >Prev</a>
				<a class=nav-next href="450-debug.html" >Next</a> 

			</div>
	</ul>

	
<nav class=next-prev>
	<a href=''></a> <a href='450-debug.html'></a>
</nav>
<footer class="container12" style="border-top: 1px solid black;padding:10px 0">
	<ul span=12 row>
		<li span=3>
			<ul>
				<li><a href="/contact.html">Contact</a>
			</ul>
		<li span=3>
			<ul>
				<li><a href="">Developers</a>
			</ul>
		<li span=4>
			<ul>
				<li><a href="">More</a>
			</ul>
		<li span=2>
			<a href="http://www.osgi.org"><img style="float:right;width:8em" src="/img/osgi-logo-256.png"></a>
	</ul>
</footer>

</body>
</html>
